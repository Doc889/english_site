<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Loading... - EnglishPath</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #7c3aed;
            --color-primary-dark: #6d28d9;
            --color-primary-light: #a78bfa;
            --color-secondary: #c4b5fd;
            --color-accent: #ddd6fe;
            --color-bg: #ffffff;
            --color-bg-alt: #faf5ff;
            --color-text: #1f2937;
            --color-text-light: #6b7280;
            --color-success: #10b981;
            --color-error: #ef4444;
            --font-display: 'Playfair Display', serif;
            --font-body: 'DM Sans', sans-serif;
            --shadow-sm: 0 2px 8px rgba(124, 58, 237, 0.08);
            --shadow-md: 0 4px 20px rgba(124, 58, 237, 0.12);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.7;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-size: 1.2rem;
            color: var(--color-primary);
        }

        /* Header */
        header {
            background: var(--color-primary);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .back-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            opacity: 0.9;
            transition: var(--transition);
        }

        .back-link:hover {
            opacity: 1;
            transform: translateX(-3px);
        }

        .topic-title {
            font-family: var(--font-display);
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .topic-description {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        /* Main Content */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .section-title {
            font-family: var(--font-display);
            font-size: 2.5rem;
            color: var(--color-primary);
            margin: 3rem 0 2rem;
            text-align: center;
        }

        .rule-card {
            background: var(--color-bg-alt);
            border-left: 4px solid var(--color-primary);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }

        .rule-title {
            font-family: var(--font-display);
            font-size: 1.8rem;
            color: var(--color-primary);
            margin-bottom: 1rem;
        }

        .rule-content {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            line-height: 1.8;
        }

        .examples-list {
            list-style: none;
            padding-left: 0;
        }

        .examples-list li {
            background: var(--color-bg);
            padding: 0.8rem 1.2rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 3px solid var(--color-secondary);
            font-family: monospace;
            font-size: 1rem;
        }

        /* Quiz Section */
        .quiz-section {
            background: var(--color-bg-alt);
            padding: 3rem;
            border-radius: 16px;
            margin-top: 3rem;
        }

        .question-card {
            background: var(--color-bg);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .question-card.correct {
            border-color: var(--color-success);
            background: #f0fdf4;
        }

        .question-card.incorrect {
            border-color: var(--color-error);
            background: #fef2f2;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            color: var(--color-text);
        }

        .options-grid {
            display: grid;
            gap: 1rem;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--color-bg-alt);
            border: 2px solid var(--color-accent);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .option:hover {
            border-color: var(--color-primary);
            background: white;
        }

        .option input[type="radio"] {
            margin-right: 1rem;
            cursor: pointer;
        }

        .option.correct {
            background: #dcfce7;
            border-color: var(--color-success);
        }

        .option.incorrect {
            background: #fee2e2;
            border-color: var(--color-error);
        }

        .explanation {
            margin-top: 1rem;
            padding: 1rem;
            background: #dcfce7;
            border-left: 4px solid var(--color-success);
            border-radius: 8px;
            color: var(--color-text);
            display: none;
        }

        .quiz-results {
            text-align: center;
            padding: 2rem;
            background: var(--color-primary);
            color: white;
            border-radius: 12px;
            margin-top: 2rem;
            display: none;
        }

        .quiz-results h3 {
            font-family: var(--font-display);
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .quiz-results p {
            font-size: 1.2rem;
        }

        .submit-btn {
            display: block;
            width: 100%;
            padding: 1.2rem;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 2rem;
            transition: var(--transition);
        }

        .submit-btn:hover:not(:disabled) {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background: var(--color-text-light);
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            text-align: center;
            padding: 2rem;
            color: var(--color-error);
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .topic-title {
                font-size: 2rem;
            }

            .section-title {
                font-size: 2rem;
            }

            .container {
                padding: 2rem 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        Loading topic...
    </div>

    <div id="content" style="display: none;">
        <header>
            <a href="/" class="back-link">‚Üê Back to All Topics</a>
            <h1 id="topic-title" class="topic-title"></h1>
            <p id="topic-description" class="topic-description"></p>
        </header>

        <div class="container">
            <h2 class="section-title">üìö Rules & Explanations</h2>
            <div id="rules-container"></div>

            <div class="quiz-section">
                <h2 class="section-title">‚úèÔ∏è Practice Quiz</h2>
                <p style="text-align: center; margin-bottom: 2rem; font-size: 1.1rem;">
                    Test your knowledge with <span id="question-count"></span> questions!
                </p>

                <form id="quizForm">
                    <div id="questions-container"></div>
                    <button type="submit" class="submit-btn">Check Answers</button>
                </form>

                <div class="quiz-results" id="results"></div>
            </div>
        </div>
    </div>

    <div id="error" class="error-message" style="display: none;"></div>

    <script>
        // Get topic ID from URL path
        const pathParts = window.location.pathname.split('/');
        const topicId = pathParts[pathParts.length - 1].replace('.html', '');

        // API base URL
        const API_BASE = window.location.origin + '/api';

        // Fetch and render topic content
        async function loadTopic() {
            try {
                const response = await fetch(`${API_BASE}/content/${topicId}`);

                if (!response.ok) {
                    throw new Error(`Failed to load topic: ${response.statusText}`);
                }

                const data = await response.json();
                renderTopic(data);

                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Error loading topic:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Failed to load topic. Please try again later.';
            }
        }

        function renderTopic(data) {
            // Set page title and header
            document.getElementById('page-title').textContent = `${data.info.title} - EnglishPath`;
            document.getElementById('topic-title').textContent = data.info.title;
            document.getElementById('topic-description').textContent = data.info.description;

            // Render rules
            const rulesContainer = document.getElementById('rules-container');
            data.rules.forEach(rule => {
                const ruleCard = document.createElement('div');
                ruleCard.className = 'rule-card';

                const examplesList = rule.examples.map(ex =>
                    `<li>${ex.example_text}</li>`
                ).join('');

                ruleCard.innerHTML = `
                    <h2 class="rule-title">${rule.title}</h2>
                    <p class="rule-content">${rule.content}</p>
                    ${examplesList ? `<ul class="examples-list">${examplesList}</ul>` : ''}
                `;

                rulesContainer.appendChild(ruleCard);
            });

            // Render questions
            const questionsContainer = document.getElementById('questions-container');
            document.getElementById('question-count').textContent = data.questions.length;

            data.questions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.dataset.questionId = question.id;
                questionCard.dataset.correctIndex = question.correct_index;

                // Sort options by option_index
                const sortedOptions = [...question.options].sort((a, b) =>
                    a.option_index - b.option_index
                );

                const optionsHtml = sortedOptions.map(option => `
                    <label class="option">
                        <input type="radio"
                               name="q${question.id}"
                               value="${option.option_index}"
                               data-option-id="${option.id}">
                        <span>${option.option_text}</span>
                    </label>
                `).join('');

                questionCard.innerHTML = `
                    <h3 class="question-text">${index + 1}. ${question.question_text}</h3>
                    <div class="options-grid">
                        ${optionsHtml}
                    </div>
                    <div class="explanation">
                        <strong>‚úì Explanation:</strong> ${question.explanation}
                    </div>
                `;

                questionsContainer.appendChild(questionCard);
            });
        }

        // Handle quiz submission
        document.addEventListener('DOMContentLoaded', () => {
            const quizForm = document.getElementById('quizForm');

            if (quizForm) {
                quizForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    // Collect answers
                    const answers = [];
                    const questionCards = document.querySelectorAll('.question-card');

                    questionCards.forEach(card => {
                        const questionId = parseInt(card.dataset.questionId);
                        const selectedOption = card.querySelector('input[type="radio"]:checked');

                        if (selectedOption) {
                            answers.push({
                                question_id: questionId,
                                selected_index: parseInt(selectedOption.value)
                            });
                        }
                    });

                    // Check all questions answered
                    if (answers.length !== questionCards.length) {
                        alert('Please answer all questions before submitting!');
                        return;
                    }

                    // Disable submit button
                    const submitBtn = quizForm.querySelector('.submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';

                    try {
                        // Submit to backend
                        const response = await fetch(`${API_BASE}/quiz/submit`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                topic_id: topicId,
                                answers: answers
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to submit quiz');
                        }

                        const result = await response.json();
                        displayResults(result, questionCards);

                    } catch (error) {
                        console.error('Error submitting quiz:', error);
                        alert('Failed to submit quiz. Please try again.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Check Answers';
                    }
                });
            }
        });

        function displayResults(result, questionCards) {
            // Mark correct/incorrect answers
            questionCards.forEach(card => {
                const questionId = parseInt(card.dataset.questionId);
                const correctIndex = parseInt(card.dataset.correctIndex);
                const selectedOption = card.querySelector('input[type="radio"]:checked');

                if (selectedOption) {
                    const selectedIndex = parseInt(selectedOption.value);
                    const optionLabel = selectedOption.closest('.option');
                    const explanation = card.querySelector('.explanation');

                    if (selectedIndex === correctIndex) {
                        card.classList.add('correct');
                        optionLabel.classList.add('correct');
                    } else {
                        card.classList.add('incorrect');
                        optionLabel.classList.add('incorrect');

                        // Highlight correct answer
                        const correctOption = card.querySelector(`input[value="${correctIndex}"]`);
                        if (correctOption) {
                            correctOption.closest('.option').classList.add('correct');
                        }
                    }

                    explanation.style.display = 'block';
                }
            });

            // Show results summary
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <h3>${result.feedback_message}</h3>
                <p>You got ${result.correct_answers} out of ${result.total_questions} correct (${result.score_percentage}%)</p>
            `;
            resultsDiv.style.display = 'block';

            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Load topic on page load
        loadTopic();
    </script>
</body>
</html>
